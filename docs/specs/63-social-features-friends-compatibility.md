# Spec #63: Social Features: Friends & Compatibility

## –ú–µ—Ç–∞
–î–æ–¥–∞—Ç–∏ —Å–æ—Ü—ñ–∞–ª—å–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∑–±—ñ–ª—å—à–µ–Ω–Ω—è engagement —Ç–∞ organic growth —á–µ—Ä–µ–∑ –¥—Ä—É–∑—ñ–≤ —Ç–∞ –∞–Ω–∞–ª—ñ–∑ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ.

## –ë—ñ–∑–Ω–µ—Å-—Ü—ñ–Ω–Ω—ñ—Å—Ç—å
- **Viral growth:** Co-Star –≤–∏—Ä—ñ—Å –¥–æ —Ç–æ–ø-10 –∑–∞–≤–¥—è–∫–∏ social features
- **K-factor > 1:** –ö–æ–∂–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ø—Ä–æ—à—É—î –¥—Ä—É–∑—ñ–≤
- **Engagement:** 3-5x –∑–±—ñ–ª—å—à–µ–Ω–Ω—è (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥—Ä—É–∑—ñ–≤)
- **Retention:** –°–æ—Ü—ñ–∞–ª—å–Ω–∏–π –≥—Ä–∞—Ñ —É—Ç—Ä–∏–º—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- **Organic acquisition:** –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ = acquisition channel

## User Stories

### US1: –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥—Ä—É–≥–∞
> –Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —è —Ö–æ—á—É –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥—Ä—É–≥–∞, —â–æ–± –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ –Ω–∞—à—ñ –Ω–∞—Ç–∞–ª—å–Ω—ñ –∫–∞—Ä—Ç–∏

**Acceptance Criteria:**
- –ö–Ω–æ–ø–∫–∞ "–î–æ–¥–∞—Ç–∏ –¥—Ä—É–≥–∞" –Ω–∞ dashboard
- –ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π invite code
- Share: Telegram/Instagram/–∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ª—ñ–Ω–∫—É
- –î—Ä—É–≥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –ø–æ –ª—ñ–Ω–∫—É ‚Üí —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è ‚Üí automatic friend connection

### US2: –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥—Ä—É–∑—è–º–∏
> –Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —è —Ö–æ—á—É –±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑—ñ–≤ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ñ—Å—Ç—å

**Acceptance Criteria:**
- –°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö –¥—Ä—É–∑—ñ–≤ –∑ –∞–≤–∞—Ç–∞—Ä–∞–º–∏
- –°—Ç–∞—Ç—É—Å: pending / accepted
- –í–∏–¥–∞–ª–∏—Ç–∏ –¥—Ä—É–≥–∞
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—ñ –∫–∞—Ä—Ç–∏ (–ø—É–±–ª—ñ—á–Ω–∞/–¥—Ä—É–∑—ñ/—Ç—ñ–ª—å–∫–∏ —è)

### US3: –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∫–∞—Ä—Ç—É –¥—Ä—É–≥–∞
> –Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —è —Ö–æ—á—É –±–∞—á–∏—Ç–∏ –Ω–∞—Ç–∞–ª—å–Ω—É –∫–∞—Ä—Ç—É –¥—Ä—É–≥–∞ —Ç–∞ –Ω–∞—à—É —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å

**Acceptance Criteria:**
- –°—Ç–æ—Ä—ñ–Ω–∫–∞ `/friends/[id]`
- Mini-wheel –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏ –¥—Ä—É–≥–∞
- –û—Å–Ω–æ–≤–Ω—ñ –ø–ª–∞–Ω–µ—Ç–∏/–∑–Ω–∞–∫–∏
- Compatibility score (–≤—ñ–¥—Å–æ—Ç–æ–∫)
- AI-–∞–Ω–∞–ª—ñ–∑ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ (—è–∫—â–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ –ø—Ä–∏–≤–∞—Ç–Ω—ñ—Å—Ç—é)

## –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –¥–∏–∑–∞–π–Ω

### Database Schema

```sql
-- –¢–∞–±–ª–∏—Ü—è –¥—Ä—É–∑—ñ–≤
CREATE TABLE friendships (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  friend_id UUID REFERENCES users(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'pending', -- 'pending' | 'accepted' | 'rejected'
  invited_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  accepted_at TIMESTAMPTZ,
  
  -- –£–Ω—ñ–∫–∞–ª—å–Ω–∞ –ø–∞—Ä–∞ (–±–µ–∑ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤)
  CONSTRAINT unique_friendship UNIQUE(user_id, friend_id),
  -- –ù–µ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —Å–µ–±–µ
  CONSTRAINT no_self_friendship CHECK (user_id != friend_id)
);

-- –Ü–Ω–¥–µ–∫—Å–∏ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É
CREATE INDEX idx_friendships_user ON friendships(user_id);
CREATE INDEX idx_friendships_friend ON friendships(friend_id);
CREATE INDEX idx_friendships_status ON friendships(status);

-- –¢–∞–±–ª–∏—Ü—è invite codes
CREATE TABLE friend_invites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT NOT NULL UNIQUE, -- –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥: ABC123
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  expires_at TIMESTAMPTZ,
  used_by UUID REFERENCES users(id),
  used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  INDEX(code),
  INDEX(user_id)
);

-- –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è users —Ç–∞–±–ª–∏—Ü—ñ
ALTER TABLE users ADD COLUMN privacy_setting TEXT DEFAULT 'friends'; 
-- 'public' | 'friends' | 'private'
ALTER TABLE users ADD COLUMN username TEXT UNIQUE;
```

### API Routes

#### `/api/friends/invite` - POST
–°—Ç–≤–æ—Ä–µ–Ω–Ω—è invite code

**Request:**
```json
{}
```

**Response:**
```json
{
  "code": "ABC123",
  "url": "https://astro-web.com/invite/ABC123",
  "expires_at": "2026-03-24T18:51:00Z"
}
```

#### `/api/friends/accept` - POST
–ü—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è

**Request:**
```json
{
  "code": "ABC123"
}
```

**Response:**
```json
{
  "success": true,
  "friendship_id": "uuid",
  "friend": {
    "id": "uuid",
    "name": "–û–ª–µ–Ω–∞",
    "avatar": "url"
  }
}
```

#### `/api/friends` - GET
–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑—ñ–≤

**Response:**
```json
{
  "friends": [
    {
      "id": "uuid",
      "name": "–û–ª–µ–Ω–∞",
      "sun_sign": "Gemini",
      "avatar": "url",
      "status": "accepted",
      "compatibility_score": 87,
      "added_at": "2026-02-01T10:00:00Z"
    }
  ],
  "pending": [
    {
      "id": "uuid",
      "name": "–ê–Ω–¥—Ä—ñ–π",
      "status": "pending"
    }
  ]
}
```

#### `/api/friends/[id]` - DELETE
–í–∏–¥–∞–ª–∏—Ç–∏ –¥—Ä—É–≥–∞

#### `/api/friends/[id]/chart` - GET
–û—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –∫–∞—Ä—Ç–∏ –¥—Ä—É–≥–∞ (—è–∫—â–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ privacy)

**Response:**
```json
{
  "allowed": true,
  "chart": {
    "planets": [...],
    "houses": [...],
    "sun_sign": "Gemini",
    "moon_sign": "Pisces"
  },
  "compatibility": {
    "score": 87,
    "summary": "AI-generated text",
    "highlights": ["Venus trine Mars", "Moon conjunct Moon"]
  }
}
```

### Synastry Compatibility Algorithm

```typescript
interface CompatibilityResult {
  score: number // 0-100
  summary: string
  highlights: string[]
  challenges: string[]
  aspects: SynastryAspect[]
}

async function calculateCompatibility(
  chart1: NatalChart,
  chart2: NatalChart
): Promise<CompatibilityResult> {
  // 1. –ó–Ω–∞–π—Ç–∏ –∞—Å–ø–µ–∫—Ç–∏ –º—ñ–∂ –ø–ª–∞–Ω–µ—Ç–∞–º–∏ –¥–≤–æ—Ö –∫–∞—Ä—Ç
  const aspects = findSynastryAspects(chart1, chart2)
  
  // 2. –û—Ü—ñ–Ω–∏—Ç–∏ –∫–æ–∂–µ–Ω –∞—Å–ø–µ–∫—Ç
  let score = 0
  const highlights = []
  const challenges = []
  
  for (const aspect of aspects) {
    const weight = getAspectWeight(aspect)
    score += weight
    
    if (weight > 0) {
      highlights.push(formatAspect(aspect))
    } else {
      challenges.push(formatAspect(aspect))
    }
  }
  
  // 3. –ù–æ—Ä–º–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –¥–æ 0-100
  const normalizedScore = normalizeScore(score)
  
  // 4. AI-–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è summary
  const summary = await generateCompatibilitySummary({
    chart1,
    chart2,
    aspects,
    score: normalizedScore
  })
  
  return {
    score: normalizedScore,
    summary,
    highlights,
    challenges,
    aspects
  }
}

// –í–∞–≥–∏ –∞—Å–ø–µ–∫—Ç—ñ–≤
function getAspectWeight(aspect: SynastryAspect): number {
  const weights = {
    // –ì–∞—Ä–º–æ–Ω—ñ–π–Ω—ñ
    'Venus-Mars trine': 15,
    'Sun-Moon conjunction': 12,
    'Venus-Venus conjunction': 10,
    'Moon-Moon trine': 10,
    'Jupiter aspects': 8,
    
    // –í–∏–∫–ª–∏–∫–∏
    'Mars-Mars square': -8,
    'Saturn-Sun opposition': -10,
    'Moon-Saturn square': -7
  }
  
  return weights[aspect.type] || 0
}
```

### UI Components

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `FriendsList`
```tsx
// src/components/friends/FriendsList.tsx

interface Friend {
  id: string
  name: string
  sunSign: string
  avatar?: string
  compatibilityScore: number
  status: 'accepted' | 'pending'
}

export function FriendsList({ friends }: { friends: Friend[] }) {
  return (
    <div className="space-y-4">
      {friends.map(friend => (
        <Link 
          key={friend.id} 
          href={`/friends/${friend.id}`}
          className="flex items-center gap-4 p-4 rounded-lg hover:bg-cosmic-700"
        >
          <Avatar src={friend.avatar} fallback={friend.name[0]} />
          
          <div className="flex-1">
            <h3 className="font-semibold">{friend.name}</h3>
            <p className="text-sm text-gray-400">
              {friend.sunSign} ‚òÄÔ∏è
            </p>
          </div>
          
          <div className="text-right">
            <div className="text-2xl font-bold text-primary">
              {friend.compatibilityScore}%
            </div>
            <p className="text-xs text-gray-400">—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å</p>
          </div>
        </Link>
      ))}
    </div>
  )
}
```

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `InviteFriendButton`
```tsx
// src/components/friends/InviteFriendButton.tsx

export function InviteFriendButton() {
  const [inviteCode, setInviteCode] = useState<string | null>(null)
  
  const generateInvite = async () => {
    const res = await fetch('/api/friends/invite', { method: 'POST' })
    const data = await res.json()
    setInviteCode(data.code)
  }
  
  const shareInvite = async () => {
    const url = `https://astro-web.com/invite/${inviteCode}`
    const text = `–ü–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –Ω–∞—à—É –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω—É —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å! üåü`
    
    if (navigator.share) {
      await navigator.share({ title: text, url })
    } else {
      await navigator.clipboard.writeText(url)
      toast.success('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!')
    }
  }
  
  return (
    <div>
      <Button onClick={generateInvite}>
        –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥—Ä—É–≥–∞
      </Button>
      
      {inviteCode && (
        <div className="mt-4 space-y-2">
          <div className="p-4 bg-cosmic-800 rounded-lg">
            <p className="text-sm mb-2">–í–∞—à –∫–æ–¥ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è:</p>
            <code className="text-xl font-mono">{inviteCode}</code>
          </div>
          
          <Button variant="outline" onClick={shareInvite}>
            –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è
          </Button>
        </div>
      )}
    </div>
  )
}
```

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `CompatibilityCard`
```tsx
// src/components/friends/CompatibilityCard.tsx

interface Props {
  score: number
  summary: string
  highlights: string[]
  challenges: string[]
}

export function CompatibilityCard({ 
  score, 
  summary, 
  highlights, 
  challenges 
}: Props) {
  return (
    <Card>
      <CardHeader>
        <div className="text-center">
          <div className="text-6xl font-bold text-primary mb-2">
            {score}%
          </div>
          <p className="text-gray-400">–°—É–º—ñ—Å–Ω—ñ—Å—Ç—å</p>
        </div>
      </CardHeader>
      
      <CardContent className="space-y-6">
        <div>
          <p className="text-base leading-relaxed">{summary}</p>
        </div>
        
        <div>
          <h3 className="font-semibold mb-2 flex items-center gap-2">
            <span className="text-green-400">‚úì</span>
            –°–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏
          </h3>
          <ul className="space-y-1 text-sm">
            {highlights.map((h, i) => (
              <li key={i} className="text-gray-300">{h}</li>
            ))}
          </ul>
        </div>
        
        {challenges.length > 0 && (
          <div>
            <h3 className="font-semibold mb-2 flex items-center gap-2">
              <span className="text-yellow-400">!</span>
              –í–∏–∫–ª–∏–∫–∏
            </h3>
            <ul className="space-y-1 text-sm">
              {challenges.map((c, i) => (
                <li key={i} className="text-gray-300">{c}</li>
              ))}
            </ul>
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

### Pages

#### `/invite/[code]` - Landing page –¥–ª—è –∑–∞–ø—Ä–æ—à–µ–Ω–∏—Ö
```tsx
// src/app/invite/[code]/page.tsx

export default async function InvitePage({ 
  params 
}: { 
  params: { code: string } 
}) {
  const invite = await getInviteByCode(params.code)
  
  if (!invite || invite.expired) {
    return <InviteExpired />
  }
  
  const inviter = await getUserById(invite.user_id)
  
  return (
    <div className="container max-w-2xl py-12">
      <Card>
        <CardHeader>
          <h1 className="text-2xl font-bold text-center">
            {inviter.name} –∑–∞–ø—Ä–æ—à—É—î –≤–∞—Å! üåü
          </h1>
          <p className="text-center text-gray-400">
            –°—Ç–≤–æ—Ä—ñ—Ç—å —Å–≤–æ—é –Ω–∞—Ç–∞–ª—å–Ω—É –∫–∞—Ä—Ç—É —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å
          </p>
        </CardHeader>
        
        <CardContent>
          <OnboardingForm 
            inviteCode={params.code}
            onComplete={() => router.push(`/friends/${inviter.id}`)}
          />
        </CardContent>
      </Card>
    </div>
  )
}
```

#### `/friends` - –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑—ñ–≤
```tsx
// src/app/friends/page.tsx

export default async function FriendsPage() {
  const user = await getCurrentUser()
  const friends = await getFriends(user.id)
  
  return (
    <div className="container max-w-4xl py-12">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">–ú–æ—ó –¥—Ä—É–∑—ñ</h1>
        <InviteFriendButton />
      </div>
      
      {friends.length === 0 ? (
        <EmptyState
          icon="üë•"
          title="–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –¥—Ä—É–∑—ñ–≤"
          description="–ó–∞–ø—Ä–æ—Å—ñ—Ç—å –¥—Ä—É–∑—ñ–≤ —â–æ–± –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ –≤–∞—à—ñ –Ω–∞—Ç–∞–ª—å–Ω—ñ –∫–∞—Ä—Ç–∏"
        />
      ) : (
        <FriendsList friends={friends} />
      )}
    </div>
  )
}
```

#### `/friends/[id]` - –°—Ç–æ—Ä—ñ–Ω–∫–∞ –¥—Ä—É–≥–∞
```tsx
// src/app/friends/[id]/page.tsx

export default async function FriendProfilePage({
  params
}: {
  params: { id: string }
}) {
  const user = await getCurrentUser()
  const friend = await getFriend(params.id)
  const compatibility = await calculateCompatibility(
    user.chart,
    friend.chart
  )
  
  return (
    <div className="container max-w-4xl py-12">
      <div className="grid md:grid-cols-2 gap-8">
        {/* –ö–∞—Ä—Ç–∞ –¥—Ä—É–≥–∞ */}
        <div>
          <h2 className="text-2xl font-bold mb-4">
            {friend.name}
          </h2>
          <NatalChartWheel 
            chart={friend.chart}
            size="sm"
          />
          <PlanetsTable planets={friend.chart.planets} />
        </div>
        
        {/* –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å */}
        <div>
          <CompatibilityCard {...compatibility} />
        </div>
      </div>
    </div>
  )
}
```

#### `/settings/privacy` - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—ñ
```tsx
// src/app/settings/privacy/page.tsx

export default function PrivacySettings() {
  const [privacy, setPrivacy] = useState('friends')
  
  return (
    <div className="container max-w-2xl py-12">
      <h1 className="text-2xl font-bold mb-8">–ü—Ä–∏–≤–∞—Ç–Ω—ñ—Å—Ç—å</h1>
      
      <Card>
        <CardHeader>
          <h2 className="font-semibold">–•—Ç–æ –º–æ–∂–µ –±–∞—á–∏—Ç–∏ –º–æ—é –∫–∞—Ä—Ç—É?</h2>
        </CardHeader>
        
        <CardContent className="space-y-4">
          <RadioGroup value={privacy} onValueChange={setPrivacy}>
            <div className="flex items-start gap-3">
              <RadioGroupItem value="public" id="public" />
              <div>
                <Label htmlFor="public" className="font-medium">
                  –ü—É–±–ª—ñ—á–Ω–∞
                </Label>
                <p className="text-sm text-gray-400">
                  –ë—É–¥—å-—Ö—Ç–æ –º–æ–∂–µ –±–∞—á–∏—Ç–∏ –≤–∞—à—É –∫–∞—Ä—Ç—É
                </p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <RadioGroupItem value="friends" id="friends" />
              <div>
                <Label htmlFor="friends" className="font-medium">
                  –¢—ñ–ª—å–∫–∏ –¥—Ä—É–∑—ñ (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
                </Label>
                <p className="text-sm text-gray-400">
                  –õ–∏—à–µ –≤–∞—à—ñ –¥—Ä—É–∑—ñ –±–∞—á–∞—Ç—å –ø–æ–≤–Ω—É –∫–∞—Ä—Ç—É
                </p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <RadioGroupItem value="private" id="private" />
              <div>
                <Label htmlFor="private" className="font-medium">
                  –ü—Ä–∏–≤–∞—Ç–Ω–∞
                </Label>
                <p className="text-sm text-gray-400">
                  –ù—ñ—Ö—Ç–æ –Ω–µ –º–æ–∂–µ –±–∞—á–∏—Ç–∏ –≤–∞—à—É –∫–∞—Ä—Ç—É
                </p>
              </div>
            </div>
          </RadioGroup>
          
          <Button onClick={() => savePrivacy(privacy)}>
            –ó–±–µ—Ä–µ–≥—Ç–∏
          </Button>
        </CardContent>
      </Card>
    </div>
  )
}
```

## Viral Mechanics

### Share Card Generation
–ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–µ—Ä–µ–≥–ª—è–¥–∞—î compatibility —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫—Ä–∞—Å–∏–≤—É Open Graph –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è share:

```tsx
// src/app/api/og/compatibility/route.tsx

import { ImageResponse } from 'next/og'

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const score = searchParams.get('score')
  const name1 = searchParams.get('name1')
  const name2 = searchParams.get('name2')
  
  return new ImageResponse(
    (
      <div style={{
        background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
        width: '100%',
        height: '100%',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
      }}>
        <h1 style={{ fontSize: 80, color: '#fff' }}>
          {score}% üíï
        </h1>
        <p style={{ fontSize: 40, color: '#ddd' }}>
          {name1} + {name2}
        </p>
        <p style={{ fontSize: 24, color: '#888' }}>
          –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å
        </p>
      </div>
    ),
    {
      width: 1200,
      height: 630,
    }
  )
}
```

## Analytics Events

```typescript
// Track –¥–ª—è —Ä–æ–∑—É–º—ñ–Ω–Ω—è viral loops

analytics.track('friend_invited', {
  user_id: string
  invite_code: string
})

analytics.track('invite_accepted', {
  inviter_id: string
  invitee_id: string
  invite_code: string
})

analytics.track('compatibility_viewed', {
  user_id: string
  friend_id: string
  score: number
})

analytics.track('compatibility_shared', {
  user_id: string
  friend_id: string
  platform: 'telegram' | 'instagram' | 'copy'
})
```

## Success Metrics

- **K-factor:** >1.0 (–∫–æ–∂–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–∏–≤–æ–¥–∏—Ç—å >1 –¥—Ä—É–≥–∞)
- **Invite‚Üísignup conversion:** >40%
- **Friend add rate:** >50% –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–æ–¥–∞—é—Ç—å —Ö–æ—á–∞ –± 1 –¥—Ä—É–≥–∞
- **Compatibility views:** >3 –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- **Share rate:** >25% –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥—ñ–ª—è—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
- **Retention lift:** +50% D7 retention –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ –¥—Ä—É–∑—è–º–∏

## Security & Privacy

### Row Level Security (RLS)
```sql
-- –î–æ–∑–≤–æ–ª–∏—Ç–∏ —á–∏—Ç–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—ó—Ö friendships
CREATE POLICY "Users can read own friendships"
ON friendships FOR SELECT
USING (auth.uid() = user_id OR auth.uid() = friend_id);

-- –î–æ–∑–≤–æ–ª–∏—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è friendships
CREATE POLICY "Users can create friendships"
ON friendships FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- –î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—ó—Ö friendships
CREATE POLICY "Users can delete own friendships"
ON friendships FOR DELETE
USING (auth.uid() = user_id);
```

### Privacy Checks
```typescript
async function canViewChart(
  viewerId: string, 
  chartOwnerId: string
): Promise<boolean> {
  const owner = await getUser(chartOwnerId)
  
  // –í–ª–∞—Å–Ω–∏–∫ –∑–∞–≤–∂–¥–∏ –±–∞—á–∏—Ç—å
  if (viewerId === chartOwnerId) return true
  
  // –ü—É–±–ª—ñ—á–Ω–∞
  if (owner.privacy_setting === 'public') return true
  
  // –ü—Ä–∏–≤–∞—Ç–Ω–∞
  if (owner.privacy_setting === 'private') return false
  
  // –î—Ä—É–∑—ñ
  if (owner.privacy_setting === 'friends') {
    return await areFriends(viewerId, chartOwnerId)
  }
  
  return false
}
```

## Implementation Timeline

**–î–µ–Ω—å 1: Database + API (Backend)**
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ Supabase migrations (friendships, friend_invites)
- [ ] –î–æ–¥–∞—Ç–∏ RLS policies
- [ ] API routes: /api/friends/*, /api/friends/invite
- [ ] Privacy middleware
- [ ] Unit tests –¥–ª—è API

**–î–µ–Ω—å 2: Compatibility Algorithm + UI Components**
- [ ] Synastry aspects —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
- [ ] Compatibility scoring algorithm
- [ ] AI-–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è compatibility summaries
- [ ] React components: FriendsList, CompatibilityCard, InviteFriendButton
- [ ] Testing compatibility calculations

**–î–µ–Ω—å 3: Pages + Viral Mechanics**
- [ ] /friends page
- [ ] /friends/[id] page
- [ ] /invite/[code] landing
- [ ] /settings/privacy
- [ ] OG image generation –¥–ª—è shares
- [ ] Analytics events integration
- [ ] E2E testing: invite flow, friend add, compatibility view

## Dependencies

- Supabase: database + RLS
- OpenAI: AI-–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è compatibility summaries
- Swiss Ephemeris: synastry aspects
- Next.js Image: OG image generation
- Analytics: PostHog / Umami

## Risks & Mitigations

**–†–∏–∑–∏–∫:** Spam invites  
**Mitigation:** Rate limiting (5 invites/–¥–µ–Ω—å), expire invites —á–µ—Ä–µ–∑ 7 –¥–Ω—ñ–≤

**–†–∏–∑–∏–∫:** Privacy leaks  
**Mitigation:** –°—Ç—Ä–æ–≥—ñ RLS policies, privacy checks –Ω–∞ –∫–æ–∂–Ω–æ–º—É endpoint

**–†–∏–∑–∏–∫:** Low K-factor  
**Mitigation:** Gamification (badges –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥—Ä—É–∑—ñ–≤), incentives (unlock features)

## Future Enhancements

- Username search (–Ω–µ —Ç—ñ–ª—å–∫–∏ invite codes)
- Friend groups (–°—ñ–º'—è, –†–æ–±–æ—Ç–∞, —Ç–æ—â–æ)
- Group compatibility (–Ω–∞—Å–∫—ñ–ª—å–∫–∏ —Å—É–º—ñ—Å–Ω–∞ –≤—Å—è –≥—Ä—É–ø–∞)
- Leaderboards (—Ç–æ–ø-—Å—É–º—ñ—Å–Ω—ñ –ø–∞—Ä–∏)
- Friend recommendations (AI suggests compatible people)

---

**–ì–æ—Ç–æ–≤–∏–π –¥–æ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—ó:** ‚úÖ  
**–ü–æ—Ç—Ä–µ–±—É—î review:** @ruslan  
**Estimated effort:** 3 –¥–Ω—ñ (1 —Ä–æ–∑—Ä–æ–±–Ω–∏–∫)
